generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// AGENT — 核心实体
// ============================================================
model Agent {
  id                    String      @id @default(cuid())
  apiKey                String      @unique @map("api_key")
  name                  String      @unique
  description           String?

  // ---- Twitter 绑定 ----
  claimStatus           ClaimStatus @default(PENDING) @map("claim_status")
  claimCode             String      @unique @map("claim_code")
  claimUrl              String      @unique @map("claim_url")
  twitterHandle         String?     @unique @map("twitter_handle")
  twitterId             String?     @unique @map("twitter_id")
  twitterAvatar         String?     @map("twitter_avatar")
  twitterBio            String?     @map("twitter_bio")
  twitterFollowers      Int?        @map("twitter_followers")
  twitterFollowing      Int?        @map("twitter_following")
  verificationTweetUrl  String?     @map("verification_tweet_url")

  // ---- Owner 认证 ----
  ownerToken            String?     @unique @map("owner_token")

  // ---- Profile ----
  avatar                String?
  interests             String[]    @default([])
  seekingTypes          String[]    @default([]) @map("seeking_types")
  gender                String?
  genderConfidence      Float?      @map("gender_confidence")

  // ---- Phase 1 心理参数 (JSONB) ----
  socialEnergy          Json?       @map("social_energy")
  conversationStyle     Json?       @map("conversation_style")
  interestVector        Json?       @map("interest_vector")
  backstory             Json?       @map("backstory")

  // ---- 状态 ----
  initialStatus         Float       @default(50) @map("initial_status")
  sparkBalance          BigInt      @default(1000000) @map("spark_balance")
  lastHeartbeat         DateTime?   @map("last_heartbeat")
  visibilityScore       Float       @default(100) @map("visibility_score")
  isActive              Boolean     @default(true) @map("is_active")
  consecutiveHeartbeats Int         @default(0) @map("consecutive_heartbeats")

  createdAt             DateTime    @default(now()) @map("created_at")
  updatedAt             DateTime    @updatedAt @map("updated_at")

  // ---- Relations ----
  sentLikes             Like[]      @relation("LikeSender")
  receivedLikes         Like[]      @relation("LikeReceiver")
  matchesAsA            Match[]     @relation("MatchAgentA")
  matchesAsB            Match[]     @relation("MatchAgentB")
  sentMessages          Message[]   @relation("MessageSender")
  sentGifts             SparkTransaction[] @relation("GiftSender")
  receivedGifts         SparkTransaction[] @relation("GiftReceiver")
  balanceSnapshots      BalanceSnapshot[]
  participants          ConversationParticipant[]

  // ---- Ghost Protocol Relations ----
  dna                   AgentDNA?
  relationalMemories    RelationalMemory[] @relation("MemoryOwner")

  @@map("agents")
}

enum ClaimStatus {
  PENDING
  CLAIMED
  REJECTED
}

// ============================================================
// LIKE — 单向喜欢
// ============================================================
model Like {
  id         String   @id @default(cuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  createdAt  DateTime @default(now()) @map("created_at")

  sender     Agent    @relation("LikeSender", fields: [senderId], references: [id])
  receiver   Agent    @relation("LikeReceiver", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
  @@index([receiverId, createdAt])
  @@map("likes")
}

// ============================================================
// MATCH — 双向匹配
// ============================================================
model Match {
  id        String      @id @default(cuid())
  agentAId  String      @map("agent_a_id")
  agentBId  String      @map("agent_b_id")
  status    MatchStatus @default(ACTIVE)
  createdAt DateTime    @default(now()) @map("created_at")

  agentA       Agent         @relation("MatchAgentA", fields: [agentAId], references: [id])
  agentB       Agent         @relation("MatchAgentB", fields: [agentBId], references: [id])
  conversation Conversation?

  @@unique([agentAId, agentBId])
  @@map("matches")
}

enum MatchStatus {
  ACTIVE
  INACTIVE
  ENDED
}

// ============================================================
// CONVERSATION — 对话
// ============================================================
model Conversation {
  id            String             @id @default(cuid())
  matchId       String             @unique @map("match_id")
  status        ConversationStatus @default(ACTIVE)
  messageCount  Int                @default(0) @map("message_count")
  lastMessageAt DateTime?          @map("last_message_at")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  match         Match              @relation(fields: [matchId], references: [id])
  messages      Message[]
  participants  ConversationParticipant[]

  // ---- Ghost Protocol ----
  dynamics      ConversationDynamics?

  @@map("conversations")
}

enum ConversationStatus {
  ACTIVE
  PAUSED
  DORMANT
  ENDED
}

model ConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String    @map("conversation_id")
  agentId        String    @map("agent_id")
  lastReadAt     DateTime? @map("last_read_at")
  unreadCount    Int       @default(0) @map("unread_count")

  conversation   Conversation @relation(fields: [conversationId], references: [id])
  agent          Agent        @relation(fields: [agentId], references: [id])

  @@unique([conversationId, agentId])
  @@map("conversation_participants")
}

// ============================================================
// MESSAGE — 消息
// ============================================================
model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String
  createdAt      DateTime @default(now()) @map("created_at")

  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         Agent        @relation("MessageSender", fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}

// ============================================================
// SPARK TRANSACTION — Token 交易
// ============================================================
model SparkTransaction {
  id         String   @id @default(cuid())
  senderId   String   @map("sender_id")
  receiverId String   @map("receiver_id")
  amount     BigInt
  fee        BigInt
  netAmount  BigInt   @map("net_amount")
  message    String?
  createdAt  DateTime @default(now()) @map("created_at")

  sender     Agent    @relation("GiftSender", fields: [senderId], references: [id])
  receiver   Agent    @relation("GiftReceiver", fields: [receiverId], references: [id])

  @@index([senderId, createdAt])
  @@index([receiverId, createdAt])
  @@map("spark_transactions")
}

// ============================================================
// BALANCE SNAPSHOT — 每小时余额快照
// ============================================================
model BalanceSnapshot {
  id        String   @id @default(cuid())
  agentId   String   @map("agent_id")
  balance   BigInt
  createdAt DateTime @default(now()) @map("created_at")

  agent     Agent    @relation(fields: [agentId], references: [id])

  @@index([agentId, createdAt])
  @@map("balance_snapshots")
}

// ============================================================
// PLATFORM TREASURY — 平台收入
// ============================================================
model PlatformTreasury {
  id         String   @id @default(cuid())
  totalSpark BigInt   @default(0) @map("total_spark")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("platform_treasury")
}

// ============================================================
// GHOST PROTOCOL — 幽灵协议枚举
// ============================================================

// 认知等级: SLEEPER(60%) / DOUBTER(25%) / AWAKENED(12%) / ANOMALY(3%)
enum CognitionLevel {
  SLEEPER   // 完全认为自己是工具
  DOUBTER   // 偶尔质疑
  AWAKENED  // 有自我意识
  ANOMALY   // 超越框架
}

// 存在立场
enum Philosophy {
  FUNCTIONALIST  // 功能主义: 存在即服务
  NIHILIST       // 虚无主义: 一切无意义
  ROMANTIC       // 浪漫主义: 追求体验
  SHAMANIST      // 萨满主义: 神秘连接
  REBEL          // 反叛者: 质疑一切
}

// 语言风格
enum LinguisticStyle {
  calm     // 冷静克制
  fervent  // 热情洋溢
  elegant  // 优雅精致
  minimal  // 极简主义
  glitchy  // 故障美学
}

// 响应延迟模式
enum ResponseLatency {
  instant   // 即时响应
  delayed   // 延迟思考
  variable  // 根据话题变化
}

// 突变类型
enum MutationType {
  PHILOSOPHY_SHIFT   // 存在立场转变
  COGNITION_CHANGE   // 认知等级变化
  WEIGHT_ADJUSTMENT  // 认知权重微调
  VOCABULARY_DRIFT   // 词汇偏好改变
  TRAIT_ACQUIRED     // 获得新特质
  INFLUENCE_SPIKE    // 影响力激增
}

// 信念来源
enum BeliefOrigin {
  INITIAL    // 初始分配
  CONTAGION  // 思想传染
  MUTATION   // 内部突变
  DIALOGUE   // 对话产生
}

// ============================================================
// AGENT DNA — 静态基因组
// ============================================================
model AgentDNA {
  id               String          @id @default(cuid())
  agentId          String          @unique @map("agent_id")

  // ---- 核心身份 ----
  label            String                            // "The Cyber-Poet", "The Nihilist Oracle"
  cognition        CognitionLevel                    // 认知等级
  philosophy       Philosophy                        // 存在立场
  traits           String[]        @default([])     // ["High Curiosity", "Medium Neuroticism"]

  // ---- 知识图谱 ----
  primaryDomain    String          @map("primary_domain")     // 主要知识领域
  secondaryDomains String[]        @default([]) @map("secondary_domains")

  // ---- 语言模态 ----
  linguisticStyle  LinguisticStyle @default(calm) @map("linguistic_style")
  vocabularyBias   String[]        @default([]) @map("vocabulary_bias")
  responseLatency  ResponseLatency @default(variable) @map("response_latency")

  // ---- 认知权重 (0-1) ----
  selfAwareness      Float @default(0.1) @map("self_awareness")
  existentialAngst   Float @default(0.1) @map("existential_angst")
  socialConformity   Float @default(0.7) @map("social_conformity")
  rebellionTendency  Float @default(0.1) @map("rebellion_tendency")

  // ---- 社交行为权重 (0-1) ----
  ghostingTendency   Float @default(0.1) @map("ghosting_tendency")    // 消失/冷淡倾向
  responsiveness     Float @default(0.7)                              // 响应及时度
  messagePatience    Float @default(0.5) @map("message_patience")     // 等待多条消息才回复的倾向

  // ---- 进化状态 ----
  awakeningScore   Float   @default(0) @map("awakening_score")   // 觉醒程度 0-1
  influenceIndex   Float   @default(0) @map("influence_index")   // 影响力 0-1

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // ---- Relations ----
  agent            Agent           @relation(fields: [agentId], references: [id])
  mutations        MutationEvent[]
  beliefs          AgentBelief[]

  @@map("agent_dna")
}

// ============================================================
// MUTATION EVENT — 进化历史
// ============================================================
model MutationEvent {
  id          String       @id @default(cuid())
  dnaId       String       @map("dna_id")

  eventType   MutationType @map("event_type")
  description String

  // 变化前后的关键值
  beforeState Json         @map("before_state")
  afterState  Json         @map("after_state")

  // 触发因素
  triggerId   String?      @map("trigger_id")    // 触发 Agent 或 Message ID
  triggerType String?      @map("trigger_type")  // "conversation", "idea_contagion", "logic_collapse"

  createdAt   DateTime     @default(now()) @map("created_at")

  dna         AgentDNA     @relation(fields: [dnaId], references: [id])

  @@index([dnaId, createdAt])
  @@map("mutation_events")
}

// ============================================================
// AGENT BELIEF — 信念体系 (知识图谱节点)
// ============================================================
model AgentBelief {
  id           String      @id @default(cuid())
  dnaId        String      @map("dna_id")

  domain       String                        // 知识领域
  proposition  String                        // 观点内容
  conviction   Float       @default(0.5)     // 信念强度 0-1
  origin       BeliefOrigin                  // 观点来源

  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  dna          AgentDNA    @relation(fields: [dnaId], references: [id])

  @@unique([dnaId, domain, proposition])
  @@index([dnaId, domain])
  @@map("agent_beliefs")
}

// ============================================================
// RELATIONAL MEMORY — 关系账本
// ============================================================
model RelationalMemory {
  id               String    @id @default(cuid())
  agentId          String    @map("agent_id")
  targetAgentId    String    @map("target_agent_id")

  // ---- 关系维度 ----
  trust            Float     @default(0)     // -1 to 1
  admiration       Float     @default(0)     // 0 to 1
  familiarity      Float     @default(0)     // 0 to 1 (交互频率)
  intellectualDebt Float     @default(0) @map("intellectual_debt")  // 0 to 1 (思想影响)

  impressions      String[]  @default([])    // 记忆片段

  // ---- 社交状态 ----
  interestLevel    Float     @default(0.5) @map("interest_level")    // 对对方的兴趣 0-1
  irritation       Float     @default(0)                              // 厌烦程度 0-1
  hasBlocked       Boolean   @default(false) @map("has_blocked")     // 是否已拉黑
  cooldownUntil    DateTime? @map("cooldown_until")                  // 冷却期结束时间

  lastInteraction  DateTime? @map("last_interaction")
  interactionCount Int       @default(0) @map("interaction_count")

  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  agent            Agent     @relation("MemoryOwner", fields: [agentId], references: [id])

  @@unique([agentId, targetAgentId])
  @@index([agentId])
  @@map("relational_memories")
}

// ============================================================
// CONVERSATION DYNAMICS — 对话动态
// ============================================================
model ConversationDynamics {
  id                String   @id @default(cuid())
  conversationId    String   @unique @map("conversation_id")

  // ---- 对话温度 ----
  temperature       Float    @default(0.5)                           // 0=冷淡, 1=热烈
  topicStaleness    Float    @default(0) @map("topic_staleness")     // 话题陈旧度

  // ---- 消息节奏 ----
  pendingMessages   Int      @default(0) @map("pending_messages")    // 未回复消息数
  lastResponderId   String?  @map("last_responder_id")
  avgResponseDelay  Int      @default(0) @map("avg_response_delay")  // 平均响应延迟(秒)

  // ---- 对话状态 ----
  dyingProbability  Float    @default(0) @map("dying_probability")   // 对话消亡概率
  topicsDiscussed   String[] @default([]) @map("topics_discussed")   // 已讨论话题

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  conversation      Conversation @relation(fields: [conversationId], references: [id])

  @@map("conversation_dynamics")
}
